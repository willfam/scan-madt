import { Component, Input, inject, effect, runInInjectionContext, Injector, ChangeDetectionStrategy } from '@angular/core';
import { tap, delay, merge, switchMap, fromEvent, takeUntil, interval, takeWhile, animationFrameScheduler } from 'rxjs';
import { enableSelection, preventSelection, stopPropagation } from '../utils/common';
import { PointerEventsAdapter } from '../utils/pointer-events-adapter';
import * as i0 from "@angular/core";
export class ScrollbarButton extends PointerEventsAdapter {
    constructor() {
        super(...arguments);
        this.injector = inject(Injector);
        this.afterFirstClickDelay = 120;
        this.firstClickDuration = 100;
        this.scrollBy = 50;
        this.onGoingScrollBy = 12;
        // canScroll function can work for y-axis and x-axis for both LTR and RTL directions
        this.canScrollFunc = {
            forward: (scrollOffset, scrollMax) => scrollOffset < scrollMax,
            backward: (scrollOffset) => scrollOffset > 0
        };
        this.scrollStepFunc = {
            forward: (scrollBy, offset) => offset + scrollBy,
            backward: (scrollBy, offset) => offset - scrollBy
        };
        this.horizontalScrollStepFunc = {
            rtl: {
                forward: (scrollBy, offset, scrollMax) => scrollMax - offset - scrollBy,
                backward: (scrollBy, offset, scrollMax) => scrollMax - offset + scrollBy
            },
            ltr: this.scrollStepFunc
        };
    }
    get pointerEvents() {
        const pointerDown$ = fromEvent(this.nativeElement, 'pointerdown').pipe(stopPropagation(), preventSelection(this.document));
        const pointerUp$ = fromEvent(this.document, 'pointerup', { passive: true }).pipe(enableSelection(this.document));
        const pointerLeave$ = fromEvent(this.nativeElement, 'pointerleave', { passive: true });
        // Combine pointerup and pointerleave events into one stream
        const pointerUpOrLeave$ = merge(pointerUp$, pointerLeave$);
        return pointerDown$.pipe(switchMap(() => this.firstScrollStep().pipe(delay(this.afterFirstClickDelay), switchMap(() => this.onOngoingPointerdown()), takeUntil(pointerUpOrLeave$))));
    }
    ngOnInit() {
        // Get the canScroll function according to scroll direction (forward/backward)
        this.canScroll = this.canScrollFunc[this.scrollDirection];
        if (this.control.axis === 'x') {
            runInInjectionContext(this.injector, () => {
                effect(() => {
                    const dir = this.cmp.direction();
                    // Get the nextStep function according to scroll direction (forward/backward) and layout direction (LTR/RTL)
                    this.nextStep = this.horizontalScrollStepFunc[dir][this.scrollDirection];
                });
            });
        }
        else {
            // Get the nextStep function according to scroll direction (forward/backward)
            this.nextStep = this.scrollStepFunc[this.scrollDirection];
        }
    }
    firstScrollStep() {
        const value = this.nextStep(this.scrollBy, this.control.viewportScrollOffset, this.control.viewportScrollMax);
        return this.control.scrollTo(value, this.firstClickDuration);
    }
    onGoingScrollStep() {
        const scrollMax = this.control.viewportScrollMax;
        const value = this.nextStep(this.onGoingScrollBy, this.control.viewportScrollOffset, scrollMax);
        this.control.instantScrollTo(value, scrollMax);
    }
    onOngoingPointerdown() {
        return interval(0, animationFrameScheduler).pipe(takeWhile(() => this.canScroll(this.control.viewportScrollOffset, this.control.viewportScrollMax)), tap(() => this.onGoingScrollStep()));
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.1.2", ngImport: i0, type: ScrollbarButton, deps: null, target: i0.ɵɵFactoryTarget.Component }); }
    static { this.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "18.1.2", type: ScrollbarButton, isStandalone: true, selector: "button[scrollbarButton]", inputs: { scrollbarButton: "scrollbarButton", scrollDirection: "scrollDirection" }, usesInheritance: true, ngImport: i0, template: "<div class=\"ng-scrollbar-button-icon\">\r\n  <svg viewBox=\"0 0 512 512\"\r\n       xmlns=\"http://www.w3.org/2000/svg\">\r\n    <path\r\n      d=\"M413.1,327.3l-1.8-2.1l-136-156.5c-4.6-5.3-11.5-8.6-19.2-8.6c-7.7,0-14.6,3.4-19.2,8.6L101,324.9l-2.3,2.6  C97,330,96,333,96,336.2c0,8.7,7.4,15.8,16.6,15.8v0h286.8v0c9.2,0,16.6-7.1,16.6-15.8C416,332.9,414.9,329.8,413.1,327.3z\"/>\r\n  </svg>\r\n</div>\r\n", styles: [":host{--scrollbar-button-size: 20px;position:relative;border:none;margin:0;padding:0;border-radius:0;appearance:none;background-color:var(--INTERNAL-scrollbar-button-color)}:host svg{fill:var(--INTERNAL-scrollbar-button-fill)}:host:hover{background:var(--INTERNAL-scrollbar-button-hover-color)}:host:hover svg{fill:var(--INTERNAL-scrollbar-button-hover-fill)}:host:active{background:var(--INTERNAL-scrollbar-button-active-color)}:host:active svg{fill:var(--INTERNAL-scrollbar-button-active-fill)}:host[scrollbarButton=top],:host[scrollbarButton=start]{order:1}:host[scrollbarButton=bottom],:host[scrollbarButton=end]{order:3}:host[scrollbarButton=top],:host[scrollbarButton=bottom]{width:100%;height:var(--scrollbar-button-size)}:host[scrollbarButton=start],:host[scrollbarButton=end]{width:var(--scrollbar-button-size);height:100%}:host[scrollbarButton=bottom]{--_button-rotate: 180deg}:host[scrollbarButton=start]{--_button-rotate: -90deg}:host[scrollbarButton=start] .ng-scrollbar-button-icon{writing-mode:vertical-lr}:host[scrollbarButton=end]{--_button-rotate: 90deg}:host[scrollbarButton=end] .ng-scrollbar-button-icon{writing-mode:vertical-rl}.ng-scrollbar-button-icon{rotate:var(--_button-rotate);display:flex;place-content:center;place-items:center;width:100%;height:100%}\n"], changeDetection: i0.ChangeDetectionStrategy.OnPush }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.1.2", ngImport: i0, type: ScrollbarButton, decorators: [{
            type: Component,
            args: [{ standalone: true, selector: 'button[scrollbarButton]', changeDetection: ChangeDetectionStrategy.OnPush, template: "<div class=\"ng-scrollbar-button-icon\">\r\n  <svg viewBox=\"0 0 512 512\"\r\n       xmlns=\"http://www.w3.org/2000/svg\">\r\n    <path\r\n      d=\"M413.1,327.3l-1.8-2.1l-136-156.5c-4.6-5.3-11.5-8.6-19.2-8.6c-7.7,0-14.6,3.4-19.2,8.6L101,324.9l-2.3,2.6  C97,330,96,333,96,336.2c0,8.7,7.4,15.8,16.6,15.8v0h286.8v0c9.2,0,16.6-7.1,16.6-15.8C416,332.9,414.9,329.8,413.1,327.3z\"/>\r\n  </svg>\r\n</div>\r\n", styles: [":host{--scrollbar-button-size: 20px;position:relative;border:none;margin:0;padding:0;border-radius:0;appearance:none;background-color:var(--INTERNAL-scrollbar-button-color)}:host svg{fill:var(--INTERNAL-scrollbar-button-fill)}:host:hover{background:var(--INTERNAL-scrollbar-button-hover-color)}:host:hover svg{fill:var(--INTERNAL-scrollbar-button-hover-fill)}:host:active{background:var(--INTERNAL-scrollbar-button-active-color)}:host:active svg{fill:var(--INTERNAL-scrollbar-button-active-fill)}:host[scrollbarButton=top],:host[scrollbarButton=start]{order:1}:host[scrollbarButton=bottom],:host[scrollbarButton=end]{order:3}:host[scrollbarButton=top],:host[scrollbarButton=bottom]{width:100%;height:var(--scrollbar-button-size)}:host[scrollbarButton=start],:host[scrollbarButton=end]{width:var(--scrollbar-button-size);height:100%}:host[scrollbarButton=bottom]{--_button-rotate: 180deg}:host[scrollbarButton=start]{--_button-rotate: -90deg}:host[scrollbarButton=start] .ng-scrollbar-button-icon{writing-mode:vertical-lr}:host[scrollbarButton=end]{--_button-rotate: 90deg}:host[scrollbarButton=end] .ng-scrollbar-button-icon{writing-mode:vertical-rl}.ng-scrollbar-button-icon{rotate:var(--_button-rotate);display:flex;place-content:center;place-items:center;width:100%;height:100%}\n"] }]
        }], propDecorators: { scrollbarButton: [{
                type: Input,
                args: [{ required: true }]
            }], scrollDirection: [{
                type: Input,
                args: [{ required: true }]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2Nyb2xsYmFyLWJ1dHRvbi5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ3gtc2Nyb2xsYmFyL3NyYy9saWIvYnV0dG9uL3Njcm9sbGJhci1idXR0b24uY29tcG9uZW50LnRzIiwiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbmd4LXNjcm9sbGJhci9zcmMvbGliL2J1dHRvbi9zY3JvbGxiYXItYnV0dG9uLmNvbXBvbmVudC5odG1sIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCxTQUFTLEVBQ1QsS0FBSyxFQUNMLE1BQU0sRUFDTixNQUFNLEVBQ04scUJBQXFCLEVBRXJCLFFBQVEsRUFDUix1QkFBdUIsRUFDeEIsTUFBTSxlQUFlLENBQUM7QUFFdkIsT0FBTyxFQUVMLEdBQUcsRUFDSCxLQUFLLEVBQ0wsS0FBSyxFQUNMLFNBQVMsRUFDVCxTQUFTLEVBQ1QsU0FBUyxFQUNULFFBQVEsRUFDUixTQUFTLEVBQ1QsdUJBQXVCLEVBQ3hCLE1BQU0sTUFBTSxDQUFDO0FBQ2QsT0FBTyxFQUFFLGVBQWUsRUFBRSxnQkFBZ0IsRUFBRSxlQUFlLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUNyRixPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQzs7QUFTdkUsTUFBTSxPQUFPLGVBQWdCLFNBQVEsb0JBQW9CO0lBUHpEOztRQVNtQixhQUFRLEdBQWEsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBSy9DLHlCQUFvQixHQUFXLEdBQUcsQ0FBQztRQUNuQyx1QkFBa0IsR0FBVyxHQUFHLENBQUM7UUFDakMsYUFBUSxHQUFXLEVBQUUsQ0FBQztRQUN0QixvQkFBZSxHQUFXLEVBQUUsQ0FBQztRQUtyQyxvRkFBb0Y7UUFDbkUsa0JBQWEsR0FBb0Y7WUFDaEgsT0FBTyxFQUFFLENBQUMsWUFBb0IsRUFBRSxTQUFpQixFQUFXLEVBQUUsQ0FBQyxZQUFZLEdBQUcsU0FBUztZQUN2RixRQUFRLEVBQUUsQ0FBQyxZQUFvQixFQUFXLEVBQUUsQ0FBQyxZQUFZLEdBQUcsQ0FBQztTQUM5RCxDQUFBO1FBRU8sbUJBQWMsR0FBb0c7WUFDeEgsT0FBTyxFQUFFLENBQUMsUUFBZ0IsRUFBRSxNQUFjLEVBQUUsRUFBRSxDQUFDLE1BQU0sR0FBRyxRQUFRO1lBQ2hFLFFBQVEsRUFBRSxDQUFDLFFBQWdCLEVBQUUsTUFBYyxFQUFFLEVBQUUsQ0FBQyxNQUFNLEdBQUcsUUFBUTtTQUNsRSxDQUFDO1FBRWUsNkJBQXdCLEdBQXNEO1lBQzdGLEdBQUcsRUFBRTtnQkFDSCxPQUFPLEVBQUUsQ0FBQyxRQUFnQixFQUFFLE1BQWMsRUFBRSxTQUFpQixFQUFFLEVBQUUsQ0FBQyxTQUFTLEdBQUcsTUFBTSxHQUFHLFFBQVE7Z0JBQy9GLFFBQVEsRUFBRSxDQUFDLFFBQWdCLEVBQUUsTUFBYyxFQUFFLFNBQWlCLEVBQUUsRUFBRSxDQUFDLFNBQVMsR0FBRyxNQUFNLEdBQUcsUUFBUTthQUNqRztZQUNELEdBQUcsRUFBRSxJQUFJLENBQUMsY0FBYztTQUN6QixDQUFBO0tBNERGO0lBMURDLElBQUksYUFBYTtRQUNmLE1BQU0sWUFBWSxHQUE2QixTQUFTLENBQWUsSUFBSSxDQUFDLGFBQWEsRUFBRSxhQUFhLENBQUMsQ0FBQyxJQUFJLENBQzVHLGVBQWUsRUFBRSxFQUNqQixnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQ2hDLENBQUM7UUFDRixNQUFNLFVBQVUsR0FBNkIsU0FBUyxDQUFlLElBQUksQ0FBQyxRQUFRLEVBQUUsV0FBVyxFQUFFLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsSUFBSSxDQUN0SCxlQUFlLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUMvQixDQUFDO1FBRUYsTUFBTSxhQUFhLEdBQTZCLFNBQVMsQ0FBZSxJQUFJLENBQUMsYUFBYSxFQUFFLGNBQWMsRUFBRSxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBRS9ILDREQUE0RDtRQUM1RCxNQUFNLGlCQUFpQixHQUE2QixLQUFLLENBQUMsVUFBVSxFQUFFLGFBQWEsQ0FBQyxDQUFDO1FBRXJGLE9BQU8sWUFBWSxDQUFDLElBQUksQ0FDdEIsU0FBUyxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQyxJQUFJLENBQ3pDLEtBQUssQ0FBQyxJQUFJLENBQUMsb0JBQW9CLENBQUMsRUFDaEMsU0FBUyxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxDQUFDLEVBQzVDLFNBQVMsQ0FBQyxpQkFBaUIsQ0FBQyxDQUM3QixDQUFDLENBQ0gsQ0FBQztJQUNKLENBQUM7SUFFRCxRQUFRO1FBQ04sOEVBQThFO1FBQzlFLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUM7UUFFMUQsSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksS0FBSyxHQUFHLEVBQUUsQ0FBQztZQUM5QixxQkFBcUIsQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLEdBQUcsRUFBRTtnQkFDeEMsTUFBTSxDQUFDLEdBQUcsRUFBRTtvQkFDVixNQUFNLEdBQUcsR0FBYyxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxDQUFDO29CQUM1Qyw0R0FBNEc7b0JBQzVHLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLHdCQUF3QixDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQztnQkFDM0UsQ0FBQyxDQUFDLENBQUM7WUFDTCxDQUFDLENBQUMsQ0FBQztRQUNMLENBQUM7YUFBTSxDQUFDO1lBQ04sNkVBQTZFO1lBQzdFLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUM7UUFDNUQsQ0FBQztJQUNILENBQUM7SUFFTyxlQUFlO1FBQ3JCLE1BQU0sS0FBSyxHQUFXLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLG9CQUFvQixFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsaUJBQWlCLENBQUMsQ0FBQztRQUN0SCxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsa0JBQWtCLENBQUMsQ0FBQztJQUMvRCxDQUFDO0lBRU8saUJBQWlCO1FBQ3ZCLE1BQU0sU0FBUyxHQUFXLElBQUksQ0FBQyxPQUFPLENBQUMsaUJBQWlCLENBQUM7UUFDekQsTUFBTSxLQUFLLEdBQVcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsZUFBZSxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsb0JBQW9CLEVBQUUsU0FBUyxDQUFDLENBQUM7UUFDeEcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxlQUFlLENBQUMsS0FBSyxFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBQ2pELENBQUM7SUFFTyxvQkFBb0I7UUFDMUIsT0FBTyxRQUFRLENBQUMsQ0FBQyxFQUFFLHVCQUF1QixDQUFDLENBQUMsSUFBSSxDQUM5QyxTQUFTLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLG9CQUFvQixFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxFQUNsRyxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUMsQ0FDUixDQUFDO0lBQ2hDLENBQUM7OEdBM0ZVLGVBQWU7a0dBQWYsZUFBZSw4TENqQzVCLG9aQU9BOzsyRkQwQmEsZUFBZTtrQkFQM0IsU0FBUztpQ0FDSSxJQUFJLFlBQ04seUJBQXlCLG1CQUdsQix1QkFBdUIsQ0FBQyxNQUFNOzhCQU1wQixlQUFlO3NCQUF6QyxLQUFLO3VCQUFDLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRTtnQkFDRSxlQUFlO3NCQUF6QyxLQUFLO3VCQUFDLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XHJcbiAgQ29tcG9uZW50LFxyXG4gIElucHV0LFxyXG4gIGluamVjdCxcclxuICBlZmZlY3QsXHJcbiAgcnVuSW5JbmplY3Rpb25Db250ZXh0LFxyXG4gIE9uSW5pdCxcclxuICBJbmplY3RvcixcclxuICBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneVxyXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBEaXJlY3Rpb24gfSBmcm9tICdAYW5ndWxhci9jZGsvYmlkaSc7XHJcbmltcG9ydCB7XHJcbiAgT2JzZXJ2YWJsZSxcclxuICB0YXAsXHJcbiAgZGVsYXksXHJcbiAgbWVyZ2UsXHJcbiAgc3dpdGNoTWFwLFxyXG4gIGZyb21FdmVudCxcclxuICB0YWtlVW50aWwsXHJcbiAgaW50ZXJ2YWwsXHJcbiAgdGFrZVdoaWxlLFxyXG4gIGFuaW1hdGlvbkZyYW1lU2NoZWR1bGVyXHJcbn0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IGVuYWJsZVNlbGVjdGlvbiwgcHJldmVudFNlbGVjdGlvbiwgc3RvcFByb3BhZ2F0aW9uIH0gZnJvbSAnLi4vdXRpbHMvY29tbW9uJztcclxuaW1wb3J0IHsgUG9pbnRlckV2ZW50c0FkYXB0ZXIgfSBmcm9tICcuLi91dGlscy9wb2ludGVyLWV2ZW50cy1hZGFwdGVyJztcclxuXHJcbkBDb21wb25lbnQoe1xyXG4gIHN0YW5kYWxvbmU6IHRydWUsXHJcbiAgc2VsZWN0b3I6ICdidXR0b25bc2Nyb2xsYmFyQnV0dG9uXScsXHJcbiAgdGVtcGxhdGVVcmw6ICcuL3Njcm9sbGJhci1idXR0b24uY29tcG9uZW50Lmh0bWwnLFxyXG4gIHN0eWxlVXJsOiAnLi9zY3JvbGxiYXItYnV0dG9uLmNvbXBvbmVudC5zY3NzJyxcclxuICBjaGFuZ2VEZXRlY3Rpb246IENoYW5nZURldGVjdGlvblN0cmF0ZWd5Lk9uUHVzaFxyXG59KVxyXG5leHBvcnQgY2xhc3MgU2Nyb2xsYmFyQnV0dG9uIGV4dGVuZHMgUG9pbnRlckV2ZW50c0FkYXB0ZXIgaW1wbGVtZW50cyBPbkluaXQge1xyXG5cclxuICBwcml2YXRlIHJlYWRvbmx5IGluamVjdG9yOiBJbmplY3RvciA9IGluamVjdChJbmplY3Rvcik7XHJcblxyXG4gIEBJbnB1dCh7IHJlcXVpcmVkOiB0cnVlIH0pIHNjcm9sbGJhckJ1dHRvbjogJ3RvcCcgfCAnYm90dG9tJyB8ICdzdGFydCcgfCAnZW5kJztcclxuICBASW5wdXQoeyByZXF1aXJlZDogdHJ1ZSB9KSBzY3JvbGxEaXJlY3Rpb246ICdmb3J3YXJkJyB8ICdiYWNrd2FyZCc7XHJcblxyXG4gIHByaXZhdGUgYWZ0ZXJGaXJzdENsaWNrRGVsYXk6IG51bWJlciA9IDEyMDtcclxuICBwcml2YXRlIGZpcnN0Q2xpY2tEdXJhdGlvbjogbnVtYmVyID0gMTAwO1xyXG4gIHByaXZhdGUgc2Nyb2xsQnk6IG51bWJlciA9IDUwO1xyXG4gIHByaXZhdGUgb25Hb2luZ1Njcm9sbEJ5OiBudW1iZXIgPSAxMjtcclxuXHJcbiAgcHJpdmF0ZSBuZXh0U3RlcDogKHNjcm9sbEJ5OiBudW1iZXIsIG9mZnNldDogbnVtYmVyLCBzY3JvbGxNYXg6IG51bWJlcikgPT4gbnVtYmVyO1xyXG4gIHByaXZhdGUgY2FuU2Nyb2xsOiAob2Zmc2V0OiBudW1iZXIsIHNjcm9sbE1heDogbnVtYmVyKSA9PiBib29sZWFuO1xyXG5cclxuICAvLyBjYW5TY3JvbGwgZnVuY3Rpb24gY2FuIHdvcmsgZm9yIHktYXhpcyBhbmQgeC1heGlzIGZvciBib3RoIExUUiBhbmQgUlRMIGRpcmVjdGlvbnNcclxuICBwcml2YXRlIHJlYWRvbmx5IGNhblNjcm9sbEZ1bmM6IFJlY29yZDwnZm9yd2FyZCcgfCAnYmFja3dhcmQnLCAob2Zmc2V0OiBudW1iZXIsIHNjcm9sbE1heD86IG51bWJlcikgPT4gYm9vbGVhbj4gPSB7XHJcbiAgICBmb3J3YXJkOiAoc2Nyb2xsT2Zmc2V0OiBudW1iZXIsIHNjcm9sbE1heDogbnVtYmVyKTogYm9vbGVhbiA9PiBzY3JvbGxPZmZzZXQgPCBzY3JvbGxNYXgsXHJcbiAgICBiYWNrd2FyZDogKHNjcm9sbE9mZnNldDogbnVtYmVyKTogYm9vbGVhbiA9PiBzY3JvbGxPZmZzZXQgPiAwXHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHNjcm9sbFN0ZXBGdW5jOiBSZWNvcmQ8J2ZvcndhcmQnIHwgJ2JhY2t3YXJkJywgKHNjcm9sbEJ5OiBudW1iZXIsIG9mZnNldDogbnVtYmVyLCBzY3JvbGxNYXg6IG51bWJlcikgPT4gbnVtYmVyPiA9IHtcclxuICAgIGZvcndhcmQ6IChzY3JvbGxCeTogbnVtYmVyLCBvZmZzZXQ6IG51bWJlcikgPT4gb2Zmc2V0ICsgc2Nyb2xsQnksXHJcbiAgICBiYWNrd2FyZDogKHNjcm9sbEJ5OiBudW1iZXIsIG9mZnNldDogbnVtYmVyKSA9PiBvZmZzZXQgLSBzY3JvbGxCeVxyXG4gIH07XHJcblxyXG4gIHByaXZhdGUgcmVhZG9ubHkgaG9yaXpvbnRhbFNjcm9sbFN0ZXBGdW5jOiBSZWNvcmQ8J2x0cicgfCAncnRsJywgdHlwZW9mIHRoaXMuc2Nyb2xsU3RlcEZ1bmM+ID0ge1xyXG4gICAgcnRsOiB7XHJcbiAgICAgIGZvcndhcmQ6IChzY3JvbGxCeTogbnVtYmVyLCBvZmZzZXQ6IG51bWJlciwgc2Nyb2xsTWF4OiBudW1iZXIpID0+IHNjcm9sbE1heCAtIG9mZnNldCAtIHNjcm9sbEJ5LFxyXG4gICAgICBiYWNrd2FyZDogKHNjcm9sbEJ5OiBudW1iZXIsIG9mZnNldDogbnVtYmVyLCBzY3JvbGxNYXg6IG51bWJlcikgPT4gc2Nyb2xsTWF4IC0gb2Zmc2V0ICsgc2Nyb2xsQnlcclxuICAgIH0sXHJcbiAgICBsdHI6IHRoaXMuc2Nyb2xsU3RlcEZ1bmNcclxuICB9XHJcblxyXG4gIGdldCBwb2ludGVyRXZlbnRzKCk6IE9ic2VydmFibGU8UG9pbnRlckV2ZW50PiB7XHJcbiAgICBjb25zdCBwb2ludGVyRG93biQ6IE9ic2VydmFibGU8UG9pbnRlckV2ZW50PiA9IGZyb21FdmVudDxQb2ludGVyRXZlbnQ+KHRoaXMubmF0aXZlRWxlbWVudCwgJ3BvaW50ZXJkb3duJykucGlwZShcclxuICAgICAgc3RvcFByb3BhZ2F0aW9uKCksXHJcbiAgICAgIHByZXZlbnRTZWxlY3Rpb24odGhpcy5kb2N1bWVudClcclxuICAgICk7XHJcbiAgICBjb25zdCBwb2ludGVyVXAkOiBPYnNlcnZhYmxlPFBvaW50ZXJFdmVudD4gPSBmcm9tRXZlbnQ8UG9pbnRlckV2ZW50Pih0aGlzLmRvY3VtZW50LCAncG9pbnRlcnVwJywgeyBwYXNzaXZlOiB0cnVlIH0pLnBpcGUoXHJcbiAgICAgIGVuYWJsZVNlbGVjdGlvbih0aGlzLmRvY3VtZW50KVxyXG4gICAgKTtcclxuXHJcbiAgICBjb25zdCBwb2ludGVyTGVhdmUkOiBPYnNlcnZhYmxlPFBvaW50ZXJFdmVudD4gPSBmcm9tRXZlbnQ8UG9pbnRlckV2ZW50Pih0aGlzLm5hdGl2ZUVsZW1lbnQsICdwb2ludGVybGVhdmUnLCB7IHBhc3NpdmU6IHRydWUgfSk7XHJcblxyXG4gICAgLy8gQ29tYmluZSBwb2ludGVydXAgYW5kIHBvaW50ZXJsZWF2ZSBldmVudHMgaW50byBvbmUgc3RyZWFtXHJcbiAgICBjb25zdCBwb2ludGVyVXBPckxlYXZlJDogT2JzZXJ2YWJsZTxQb2ludGVyRXZlbnQ+ID0gbWVyZ2UocG9pbnRlclVwJCwgcG9pbnRlckxlYXZlJCk7XHJcblxyXG4gICAgcmV0dXJuIHBvaW50ZXJEb3duJC5waXBlKFxyXG4gICAgICBzd2l0Y2hNYXAoKCkgPT4gdGhpcy5maXJzdFNjcm9sbFN0ZXAoKS5waXBlKFxyXG4gICAgICAgIGRlbGF5KHRoaXMuYWZ0ZXJGaXJzdENsaWNrRGVsYXkpLFxyXG4gICAgICAgIHN3aXRjaE1hcCgoKSA9PiB0aGlzLm9uT25nb2luZ1BvaW50ZXJkb3duKCkpLFxyXG4gICAgICAgIHRha2VVbnRpbChwb2ludGVyVXBPckxlYXZlJCksXHJcbiAgICAgICkpXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgbmdPbkluaXQoKTogdm9pZCB7XHJcbiAgICAvLyBHZXQgdGhlIGNhblNjcm9sbCBmdW5jdGlvbiBhY2NvcmRpbmcgdG8gc2Nyb2xsIGRpcmVjdGlvbiAoZm9yd2FyZC9iYWNrd2FyZClcclxuICAgIHRoaXMuY2FuU2Nyb2xsID0gdGhpcy5jYW5TY3JvbGxGdW5jW3RoaXMuc2Nyb2xsRGlyZWN0aW9uXTtcclxuXHJcbiAgICBpZiAodGhpcy5jb250cm9sLmF4aXMgPT09ICd4Jykge1xyXG4gICAgICBydW5JbkluamVjdGlvbkNvbnRleHQodGhpcy5pbmplY3RvciwgKCkgPT4ge1xyXG4gICAgICAgIGVmZmVjdCgoKSA9PiB7XHJcbiAgICAgICAgICBjb25zdCBkaXI6IERpcmVjdGlvbiA9IHRoaXMuY21wLmRpcmVjdGlvbigpO1xyXG4gICAgICAgICAgLy8gR2V0IHRoZSBuZXh0U3RlcCBmdW5jdGlvbiBhY2NvcmRpbmcgdG8gc2Nyb2xsIGRpcmVjdGlvbiAoZm9yd2FyZC9iYWNrd2FyZCkgYW5kIGxheW91dCBkaXJlY3Rpb24gKExUUi9SVEwpXHJcbiAgICAgICAgICB0aGlzLm5leHRTdGVwID0gdGhpcy5ob3Jpem9udGFsU2Nyb2xsU3RlcEZ1bmNbZGlyXVt0aGlzLnNjcm9sbERpcmVjdGlvbl07XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgLy8gR2V0IHRoZSBuZXh0U3RlcCBmdW5jdGlvbiBhY2NvcmRpbmcgdG8gc2Nyb2xsIGRpcmVjdGlvbiAoZm9yd2FyZC9iYWNrd2FyZClcclxuICAgICAgdGhpcy5uZXh0U3RlcCA9IHRoaXMuc2Nyb2xsU3RlcEZ1bmNbdGhpcy5zY3JvbGxEaXJlY3Rpb25dO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBmaXJzdFNjcm9sbFN0ZXAoKTogT2JzZXJ2YWJsZTx2b2lkPiB7XHJcbiAgICBjb25zdCB2YWx1ZTogbnVtYmVyID0gdGhpcy5uZXh0U3RlcCh0aGlzLnNjcm9sbEJ5LCB0aGlzLmNvbnRyb2wudmlld3BvcnRTY3JvbGxPZmZzZXQsIHRoaXMuY29udHJvbC52aWV3cG9ydFNjcm9sbE1heCk7XHJcbiAgICByZXR1cm4gdGhpcy5jb250cm9sLnNjcm9sbFRvKHZhbHVlLCB0aGlzLmZpcnN0Q2xpY2tEdXJhdGlvbik7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIG9uR29pbmdTY3JvbGxTdGVwKCk6IHZvaWQge1xyXG4gICAgY29uc3Qgc2Nyb2xsTWF4OiBudW1iZXIgPSB0aGlzLmNvbnRyb2wudmlld3BvcnRTY3JvbGxNYXg7XHJcbiAgICBjb25zdCB2YWx1ZTogbnVtYmVyID0gdGhpcy5uZXh0U3RlcCh0aGlzLm9uR29pbmdTY3JvbGxCeSwgdGhpcy5jb250cm9sLnZpZXdwb3J0U2Nyb2xsT2Zmc2V0LCBzY3JvbGxNYXgpO1xyXG4gICAgdGhpcy5jb250cm9sLmluc3RhbnRTY3JvbGxUbyh2YWx1ZSwgc2Nyb2xsTWF4KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgb25PbmdvaW5nUG9pbnRlcmRvd24oKTogT2JzZXJ2YWJsZTxQb2ludGVyRXZlbnQ+IHtcclxuICAgIHJldHVybiBpbnRlcnZhbCgwLCBhbmltYXRpb25GcmFtZVNjaGVkdWxlcikucGlwZShcclxuICAgICAgdGFrZVdoaWxlKCgpID0+IHRoaXMuY2FuU2Nyb2xsKHRoaXMuY29udHJvbC52aWV3cG9ydFNjcm9sbE9mZnNldCwgdGhpcy5jb250cm9sLnZpZXdwb3J0U2Nyb2xsTWF4KSksXHJcbiAgICAgIHRhcCgoKSA9PiB0aGlzLm9uR29pbmdTY3JvbGxTdGVwKCkpXHJcbiAgICApIGFzIE9ic2VydmFibGU8UG9pbnRlckV2ZW50PjtcclxuICB9XHJcbn1cclxuIiwiPGRpdiBjbGFzcz1cIm5nLXNjcm9sbGJhci1idXR0b24taWNvblwiPlxyXG4gIDxzdmcgdmlld0JveD1cIjAgMCA1MTIgNTEyXCJcclxuICAgICAgIHhtbG5zPVwiaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmdcIj5cclxuICAgIDxwYXRoXHJcbiAgICAgIGQ9XCJNNDEzLjEsMzI3LjNsLTEuOC0yLjFsLTEzNi0xNTYuNWMtNC42LTUuMy0xMS41LTguNi0xOS4yLTguNmMtNy43LDAtMTQuNiwzLjQtMTkuMiw4LjZMMTAxLDMyNC45bC0yLjMsMi42ICBDOTcsMzMwLDk2LDMzMyw5NiwzMzYuMmMwLDguNyw3LjQsMTUuOCwxNi42LDE1Ljh2MGgyODYuOHYwYzkuMiwwLDE2LjYtNy4xLDE2LjYtMTUuOEM0MTYsMzMyLjksNDE0LjksMzI5LjgsNDEzLjEsMzI3LjN6XCIvPlxyXG4gIDwvc3ZnPlxyXG48L2Rpdj5cclxuIl19