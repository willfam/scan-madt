import { EventEmitter, Inject, Injectable } from '@angular/core';
import { connect } from 'mqtt-browser';
import { BehaviorSubject, merge, Observable, Subject, Subscription, using } from 'rxjs';
import { filter, publish, publishReplay, refCount } from 'rxjs/operators';
import { MqttConnectionState } from './mqtt.model';
import { MqttClientService, MqttServiceConfig } from './mqtt.module';
import * as i0 from "@angular/core";
import * as i1 from "mqtt-browser";
// A javascript function that takes two objects and merges them recursively
function mergeDeep(target, ...sources) {
    if (!sources.length) {
        return target;
    }
    const source = sources.shift();
    if (isObject(target) && isObject(source)) {
        for (const key in source) {
            if (isObject(source[key])) {
                if (!target[key]) {
                    Object.assign(target, { [key]: {} });
                }
                mergeDeep(target[key], source[key]);
            }
            else {
                Object.assign(target, { [key]: source[key] });
            }
        }
    }
    return mergeDeep(target, ...sources);
}
function isObject(item) {
    return item && typeof item === 'object' && !Array.isArray(item);
}
/**
 * With an instance of MqttService, you can observe and subscribe to MQTT in multiple places, e.g. in different components,
 * to only subscribe to the broker once per MQTT filter.
 * It also handles proper unsubscription from the broker, if the last observable with a filter is closed.
 */
export class MqttService {
    /**
     * The constructor needs [connection options]{@link IMqttServiceOptions} regarding the broker and some
     * options to configure behavior of this service, like if the connection to the broker
     * should be established on creation of this service or not.
     */
    constructor(options, client) {
        this.options = options;
        /** a map of all mqtt observables by filter */
        this.observables = {};
        /** the connection state */
        this.state = new BehaviorSubject(MqttConnectionState.CLOSED);
        /** an observable of the last mqtt message */
        this.messages = new Subject();
        this._clientId = this._generateClientId();
        this._connectTimeout = 10000;
        this._reconnectPeriod = 10000;
        this._onConnect = new EventEmitter();
        this._onReconnect = new EventEmitter();
        this._onClose = new EventEmitter();
        this._onOffline = new EventEmitter();
        this._onError = new EventEmitter();
        this._onEnd = new EventEmitter();
        this._onMessage = new EventEmitter();
        this._onSuback = new EventEmitter();
        this._onPacketsend = new EventEmitter();
        this._onPacketreceive = new EventEmitter();
        this._handleOnConnect = (e) => {
            if (this.options.connectOnCreate === true) {
                Object.keys(this.observables).forEach((filterString) => {
                    this.client.subscribe(filterString);
                });
            }
            this.state.next(MqttConnectionState.CONNECTED);
            this._onConnect.emit(e);
        };
        this._handleOnReconnect = () => {
            if (this.options.connectOnCreate === true) {
                Object.keys(this.observables).forEach((filterString) => {
                    this.client.subscribe(filterString);
                });
            }
            this.state.next(MqttConnectionState.CONNECTING);
            this._onReconnect.emit();
        };
        this._handleOnClose = () => {
            this.state.next(MqttConnectionState.CLOSED);
            this._onClose.emit();
        };
        this._handleOnOffline = () => {
            this._onOffline.emit();
        };
        this._handleOnError = (e) => {
            this._onError.emit(e);
            console.error(e);
        };
        this._handleOnEnd = () => {
            this._onEnd.emit();
        };
        this._handleOnMessage = (topic, payload, packet) => {
            this._onMessage.emit(packet);
            if (packet.cmd === 'publish') {
                this.messages.next(packet);
            }
        };
        this._handleOnPacketsend = (e) => {
            this._onPacketsend.emit(e);
        };
        this._handleOnPacketreceive = (e) => {
            this._onPacketreceive.emit(e);
        };
        if (options.connectOnCreate !== false) {
            this.connect({}, client);
        }
        this.state.subscribe();
    }
    /**
     * gets the _clientId
     */
    get clientId() {
        return this._clientId;
    }
    /** An EventEmitter to listen to connect messages */
    get onConnect() {
        return this._onConnect;
    }
    /** An EventEmitter to listen to reconnect messages */
    get onReconnect() {
        return this._onReconnect;
    }
    /** An EventEmitter to listen to close messages */
    get onClose() {
        return this._onClose;
    }
    /** An EventEmitter to listen to offline events */
    get onOffline() {
        return this._onOffline;
    }
    /** An EventEmitter to listen to error events */
    get onError() {
        return this._onError;
    }
    /** An EventEmitter to listen to close messages */
    get onEnd() {
        return this._onEnd;
    }
    /** An EventEmitter to listen to message events */
    get onMessage() {
        return this._onMessage;
    }
    /** An EventEmitter to listen to packetsend messages */
    get onPacketsend() {
        return this._onPacketsend;
    }
    /** An EventEmitter to listen to packetreceive messages */
    get onPacketreceive() {
        return this._onPacketreceive;
    }
    /** An EventEmitter to listen to suback events */
    get onSuback() {
        return this._onSuback;
    }
    /**
     * This static method shall be used to determine whether a MQTT
     * topic matches a given filter. The matching rules are specified in the MQTT
     * standard documentation and in the library test suite.
     *
     * @param  {string}  filter A filter may contain wildcards like '#' and '+'.
     * @param  {string}  topic  A topic may not contain wildcards.
     * @return {boolean}        true on match and false otherwise.
     */
    static filterMatchesTopic(filterString, topic) {
        if (filterString[0] === '#' && topic[0] === '$') {
            return false;
        }
        // Preparation: split and reverse on '/'. The JavaScript split function is sane.
        const fs = (filterString || '').split('/').reverse();
        const ts = (topic || '').split('/').reverse();
        // This function is tail recursive and compares both arrays one element at a time.
        const match = () => {
            // Cutting of the last element of both the filter and the topic using pop().
            const f = fs.pop();
            const t = ts.pop();
            switch (f) {
                // In case the filter level is '#', this is a match no matter whether
                // the topic is undefined on this level or not ('#' matches parent element as well!).
                case '#':
                    return true;
                // In case the filter level is '+', we shall dive into the recursion only if t is not undefined.
                case '+':
                    return t ? match() : false;
                // In all other cases the filter level must match the topic level,
                // both must be defined and the filter tail must match the topic
                // tail (which is determined by the recursive call of match()).
                default:
                    return f === t && (f === undefined ? true : match());
            }
        };
        return match();
    }
    /**
     * connect manually connects to the mqtt broker.
     */
    connect(opts, client) {
        const options = mergeDeep(this.options || {}, opts);
        const protocol = options.protocol || 'ws';
        const hostname = options.hostname || 'localhost';
        if (options.url) {
            this._url = options.url;
        }
        else {
            this._url = `${protocol}://${hostname}`;
            this._url += options.port ? `:${options.port}` : '';
            this._url += options.path ? `${options.path}` : '';
        }
        this.state.next(MqttConnectionState.CONNECTING);
        const mergedOptions = mergeDeep({
            clientId: this._clientId,
            reconnectPeriod: this._reconnectPeriod,
            connectTimeout: this._connectTimeout
        }, options);
        if (this.client) {
            this.client.end(true);
        }
        if (!client) {
            this.client = connect(this._url, mergedOptions);
        }
        else {
            this.client = client;
        }
        this._clientId = mergedOptions.clientId;
        this.client.on('connect', this._handleOnConnect);
        this.client.on('reconnect', this._handleOnReconnect);
        this.client.on('close', this._handleOnClose);
        this.client.on('offline', this._handleOnOffline);
        this.client.on('error', this._handleOnError);
        this.client.stream.on('error', this._handleOnError);
        this.client.on('end', this._handleOnEnd);
        this.client.on('message', this._handleOnMessage);
        this.client.on('packetsend', this._handleOnPacketsend);
        this.client.on('packetreceive', this._handleOnPacketreceive);
    }
    /**
     * disconnect disconnects from the mqtt client.
     * This method `should` be executed when leaving the application.
     */
    disconnect(force = true) {
        if (!this.client) {
            throw new Error('mqtt client not connected');
        }
        this.client.end(force);
    }
    /**
     * With this method, you can observe messages for a mqtt topic.
     * The observable will only emit messages matching the filter.
     * The first one subscribing to the resulting observable executes a mqtt subscribe.
     * The last one unsubscribing this filter executes a mqtt unsubscribe.
     * Every new subscriber gets the latest message.
     */
    observeRetained(filterString, opts = { qos: 1 }) {
        return this._generalObserve(filterString, () => publishReplay(1), opts);
    }
    /**
     * With this method, you can observe messages for a mqtt topic.
     * The observable will only emit messages matching the filter.
     * The first one subscribing to the resulting observable executes a mqtt subscribe.
     * The last one unsubscribing this filter executes a mqtt unsubscribe.
     */
    observe(filterString, opts = { qos: 1 }) {
        return this._generalObserve(filterString, () => publish(), opts);
    }
    /**
     * With this method, you can observe messages for a mqtt topic.
     * The observable will only emit messages matching the filter.
     * The first one subscribing to the resulting observable executes a mqtt subscribe.
     * The last one unsubscribing this filter executes a mqtt unsubscribe.
     * Depending on the publish function, the messages will either be replayed after new
     * subscribers subscribe or the messages are just passed through
     */
    _generalObserve(filterString, publishFn, opts) {
        if (!this.client) {
            throw new Error('mqtt client not connected');
        }
        if (!this.observables[filterString]) {
            const rejected = new Subject();
            this.observables[filterString] = using(
            // resourceFactory: Do the actual ref-counting MQTT subscription.
            // refcount is decreased on unsubscribe.
            () => {
                const subscription = new Subscription();
                this.client.subscribe(filterString, opts, (err, granted) => {
                    if (granted) { // granted can be undefined when an error occurs when the client is disconnecting
                        granted.forEach((granted_) => {
                            if (granted_.qos === 128) {
                                delete this.observables[granted_.topic];
                                this.client.unsubscribe(granted_.topic);
                                rejected.error(`subscription for '${granted_.topic}' rejected!`);
                            }
                            this._onSuback.emit({ filter: filterString, granted: granted_.qos !== 128 });
                        });
                    }
                });
                subscription.add(() => {
                    delete this.observables[filterString];
                    this.client.unsubscribe(filterString);
                });
                return subscription;
            }, 
            // observableFactory: Create the observable that is consumed from.
            // This part is not executed until the Observable returned by
            // `observe` gets actually subscribed.
            (subscription) => merge(rejected, this.messages))
                .pipe(filter((msg) => MqttService.filterMatchesTopic(filterString, msg.topic)), publishFn(), refCount());
        }
        return this.observables[filterString];
    }
    /**
     * This method returns an observable for a topic with optional options.
     * After subscribing, the actual mqtt publication will be executed and
     * the observable will emit an empty value and completes, if publishing was successful
     * or throws an error, if the publication fails.
     */
    publish(topic, message, options = {}) {
        if (!this.client) {
            throw new Error('mqtt client not connected');
        }
        return Observable.create((obs) => {
            this.client.publish(topic, message, options, (error) => {
                if (error) {
                    obs.error(error);
                }
                else {
                    obs.next();
                    obs.complete();
                }
            });
        });
    }
    /**
     * This method publishes a message for a topic with optional options.
     * If an error occurs, it will throw.
     */
    unsafePublish(topic, message, options = {}) {
        if (!this.client) {
            throw new Error('mqtt client not connected');
        }
        this.client.publish(topic, message, options, (error) => {
            if (error) {
                throw (error);
            }
        });
    }
    _generateClientId() {
        return 'client-' + Math.random().toString(36).substr(2, 19);
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.1.2", ngImport: i0, type: MqttService, deps: [{ token: MqttServiceConfig }, { token: MqttClientService }], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "17.1.2", ngImport: i0, type: MqttService, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.1.2", ngImport: i0, type: MqttService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }], ctorParameters: () => [{ type: undefined, decorators: [{
                    type: Inject,
                    args: [MqttServiceConfig]
                }] }, { type: i1.MqttClient, decorators: [{
                    type: Inject,
                    args: [MqttClientService]
                }] }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibXF0dC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcHJvamVjdHMvbmd4LW1xdHQvc3JjL2xpYi9tcXR0LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ2pFLE9BQU8sRUFBRSxPQUFPLEVBQWtGLE1BQU0sY0FBYyxDQUFDO0FBR3ZILE9BQU8sRUFBRSxlQUFlLEVBQUUsS0FBSyxFQUFFLFVBQVUsRUFBWSxPQUFPLEVBQUUsWUFBWSxFQUFrQixLQUFLLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDbEgsT0FBTyxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsYUFBYSxFQUFFLFFBQVEsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRTFFLE9BQU8sRUFTTCxtQkFBbUIsRUFDcEIsTUFBTSxjQUFjLENBQUM7QUFFdEIsT0FBTyxFQUFFLGlCQUFpQixFQUFFLGlCQUFpQixFQUFFLE1BQU0sZUFBZSxDQUFDOzs7QUFFckUsMkVBQTJFO0FBQzNFLFNBQVMsU0FBUyxDQUFDLE1BQVcsRUFBRSxHQUFHLE9BQWM7SUFDL0MsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUNwQixPQUFPLE1BQU0sQ0FBQztJQUNoQixDQUFDO0lBQ0QsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLEtBQUssRUFBRSxDQUFDO0lBRS9CLElBQUksUUFBUSxDQUFDLE1BQU0sQ0FBQyxJQUFJLFFBQVEsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDO1FBQ3pDLEtBQUssTUFBTSxHQUFHLElBQUksTUFBTSxFQUFFLENBQUM7WUFDekIsSUFBSSxRQUFRLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsQ0FBQztnQkFDMUIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDO29CQUNq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QUFLLENBQUMsQ0FBQztnQkFDbkIsQ0FBQztxQkFBTSxDQUFDO29CQUNOLEdBQUcsQ0FBQyxJQUFJLEVBQUUsQ0FBQztvQkFDWCxHQUFHLENBQUMsUUFBUSxFQUFFLENBQUM7Z0JBQ2pCLENBQUM7WUFDSCxDQUFDLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVEOzs7T0FHRztJQUNJLGFBQWEsQ0FBQyxLQUFhLEVBQUUsT0FBd0IsRUFBRSxVQUEyQixFQUFFO1FBQ3pGLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDakIsTUFBTSxJQUFJLEtBQUssQ0FBQywyQkFBMkIsQ0FBQyxDQUFDO1FBQy9DLENBQUM7UUFDRCxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxDQUFDLEtBQXdCLEVBQUUsRUFBRTtZQUN4RSxJQUFJLEtBQUssRUFBRSxDQUFDO2dCQUNWLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUNoQixDQUFDO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBdURPLGlCQUFpQjtRQUN2QixPQUFPLFNBQVMsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDOUQsQ0FBQzs4R0FuV1UsV0FBVyxrQkFTWixpQkFBaUIsYUFDakIsaUJBQWlCO2tIQVZoQixXQUFXLGNBRlYsTUFBTTs7MkZBRVAsV0FBVztrQkFIdkIsVUFBVTttQkFBQztvQkFDVixVQUFVLEVBQUUsTUFBTTtpQkFDbkI7OzBCQVVJLE1BQU07MkJBQUMsaUJBQWlCOzswQkFDeEIsTUFBTTsyQkFBQyxpQkFBaUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFdmVudEVtaXR0ZXIsIEluamVjdCwgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgY29ubmVjdCwgSUNsaWVudFB1Ymxpc2hPcHRpb25zLCBJQ2xpZW50U3Vic2NyaWJlT3B0aW9ucywgSVN1YnNjcmlwdGlvbkdyYW50LCBNcXR0Q2xpZW50IH0gZnJvbSAnbXF0dC1icm93c2VyJztcbmltcG9ydCB7IFBhY2tldCB9IGZyb20gJ21xdHQtcGFja2V0JztcblxuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBtZXJnZSwgT2JzZXJ2YWJsZSwgT2JzZXJ2ZXIsIFN1YmplY3QsIFN1YnNjcmlwdGlvbiwgVW5zdWJzY3JpYmFibGUsIHVzaW5nIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBmaWx0ZXIsIHB1Ymxpc2gsIHB1Ymxpc2hSZXBsYXksIHJlZkNvdW50IH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQge1xuICBJTXF0dE1lc3NhZ2UsXG4gIElNcXR0U2VydmljZU9wdGlvbnMsXG4gIElPbkNvbm5lY3RFdmVudCxcbiAgSU9uRXJyb3JFdmVudCxcbiAgSU9uUGFja2V0cmVjZWl2ZUV2ZW50LFxuICBJT25QYWNrZXRzZW5kRXZlbnQsXG4gIElPblN1YmFja0V2ZW50LFxuICBJUHVibGlzaE9wdGlvbnMsXG4gIE1xdHRDb25uZWN0aW9uU3RhdGVcbn0gZnJvbSAnLi9tcXR0Lm1vZGVsJztcblxuaW1wb3J0IHsgTXF0dENsaWVudFNlcnZpY2UsIE1xdHRTZXJ2aWNlQ29uZmlnIH0gZnJvbSAnLi9tcXR0Lm1vZHVsZSc7XG5cbi8vIEEgamF2YXNjcmlwdCBmdW5jdGlvbiB0aGF0IHRha2VzIHR3byBvYmplY3RzIGFuZCBtZXJnZXMgdGhlbSByZWN1cnNpdmVseVxuZnVuY3Rpb24gbWVyZ2VEZWVwKHRhcmdldDogYW55LCAuLi5zb3VyY2VzOiBhbnlbXSk6IGFueSB7XG4gIGlmICghc291cmNlcy5sZW5ndGgpIHtcbiAgICByZXR1cm4gdGFyZ2V0O1xuICB9XG4gIGNvbnN0IHNvdXJjZSA9IHNvdXJjZXMuc2hpZnQoKTtcblxuICBpZiAoaXNPYmplY3QodGFyZ2V0KSAmJiBpc09iamVjdChzb3VyY2UpKSB7XG4gICAgZm9yIChjb25zdCBrZXkgaW4gc291cmNlKSB7XG4gICAgICBpZiAoaXNPYmplY3Qoc291cmNlW2tleV0pKSB7XG4gICAgICAgIGlmICghdGFyZ2V0W2tleV0pIHtcbiAgICAgICAgICBPYmplY3QuYXNzaWduKHRhcmdldCwgeyBba2V5XToge30gfSk7XG4gICAgICAgIH1cbiAgICAgICAgbWVyZ2VEZWVwKHRhcmdldFtrZXldLCBzb3VyY2Vba2V5XSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBPYmplY3QuYXNzaWduKHRhcmdldCwgeyBba2V5XTogc291cmNlW2tleV0gfSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIG1lcmdlRGVlcCh0YXJnZXQsIC4uLnNvdXJjZXMpO1xufVxuXG5mdW5jdGlvbiBpc09iamVjdChpdGVtOiBhbnkpOiBpdGVtIGlzIE9iamVjdCB7XG4gIHJldHVybiBpdGVtICYmIHR5cGVvZiBpdGVtID09PSAnb2JqZWN0JyAmJiAhQXJyYXkuaXNBcnJheShpdGVtKTtcbn1cblxuLyoqXG4gKiBXaXRoIGFuIGluc3RhbmNlIG9mIE1xdHRTZXJ2aWNlLCB5b3UgY2FuIG9ic2VydmUgYW5kIHN1YnNjcmliZSB0byBNUVRUIGluIG11bHRpcGxlIHBsYWNlcywgZS5nLiBpbiBkaWZmZXJlbnQgY29tcG9uZW50cyxcbiAqIHRvIG9ubHkgc3Vic2NyaWJlIHRvIHRoZSBicm9rZXIgb25jZSBwZXIgTVFUVCBmaWx0ZXIuXG4gKiBJdCBhbHNvIGhhbmRsZXMgcHJvcGVyIHVuc3Vic2NyaXB0aW9uIGZyb20gdGhlIGJyb2tlciwgaWYgdGhlIGxhc3Qgb2JzZXJ2YWJsZSB3aXRoIGEgZmlsdGVyIGlzIGNsb3NlZC5cbiAqL1xuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCcsXG59KVxuZXhwb3J0IGNsYXNzIE1xdHRTZXJ2aWNlIHtcbiAgcHJpdmF0ZSBjbGllbnQhOiBNcXR0Q2xpZW50O1xuXG4gIC8qKlxuICAgKiBUaGUgY29uc3RydWN0b3IgbmVlZHMgW2Nvbm5lY3Rpb24gb3B0aW9uc117QGxpbmsgSU1xdHRTZXJ2aWNlT3B0aW9uc30gcmVnYXJkaW5nIHRoZSBicm9rZXIgYW5kIHNvbWVcbiAgICogb3B0aW9ucyB0byBjb25maWd1cmUgYmVoYXZpb3Igb2YgdGhpcyBzZXJ2aWNlLCBsaWtlIGlmIHRoZSBjb25uZWN0aW9uIHRvIHRoZSBicm9rZXJcbiAgICogc2hvdWxkIGJlIGVzdGFibGlzaGVkIG9uIGNyZWF0aW9uIG9mIHRoaXMgc2VydmljZSBvciBub3QuXG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBASW5qZWN0KE1xdHRTZXJ2aWNlQ29uZmlnKSBwcml2YXRlIG9wdGlvbnM6IElNcXR0U2VydmljZU9wdGlvbnMsXG4gICAgQEluamVjdChNcXR0Q2xpZW50U2VydmljZSkgY2xpZW50PzogTXF0dENsaWVudFxuICApIHtcbiAgICBpZiAob3B0aW9ucy5jb25uZWN0T25DcmVhdGUgIT09IGZhbHNlKSB7XG4gICAgICB0aGlzLmNvbm5lY3Qoe30sIGNsaWVudCk7XG4gICAgfVxuXG4gICAgdGhpcy5zdGF0ZS5zdWJzY3JpYmUoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBnZXRzIHRoZSBfY2xpZW50SWRcbiAgICovXG4gIHB1YmxpYyBnZXQgY2xpZW50SWQoKSB7XG4gICAgcmV0dXJuIHRoaXMuX2NsaWVudElkO1xuICB9XG5cbiAgLyoqIEFuIEV2ZW50RW1pdHRlciB0byBsaXN0ZW4gdG8gY29ubmVjdCBtZXNzYWdlcyAqL1xuICBwdWJsaWMgZ2V0IG9uQ29ubmVjdCgpOiBFdmVudEVtaXR0ZXI8SU9uQ29ubmVjdEV2ZW50PiB7XG4gICAgcmV0dXJuIHRoaXMuX29uQ29ubmVjdDtcbiAgfVxuXG4gIC8qKiBBbiBFdmVudEVtaXR0ZXIgdG8gbGlzdGVuIHRvIHJlY29ubmVjdCBtZXNzYWdlcyAqL1xuICBwdWJsaWMgZ2V0IG9uUmVjb25uZWN0KCk6IEV2ZW50RW1pdHRlcjx2b2lkPiB7XG4gICAgcmV0dXJuIHRoaXMuX29uUmVjb25uZWN0O1xuICB9XG5cbiAgLyoqIEFuIEV2ZW50RW1pdHRlciB0byBsaXN0ZW4gdG8gY2xvc2UgbWVzc2FnZXMgKi9cbiAgcHVibGljIGdldCBvbkNsb3NlKCk6IEV2ZW50RW1pdHRlcjx2b2lkPiB7XG4gICAgcmV0dXJuIHRoaXMuX29uQ2xvc2U7XG4gIH1cblxuICAvKiogQW4gRXZlbnRFbWl0dGVyIHRvIGxpc3RlbiB0byBvZmZsaW5lIGV2ZW50cyAqL1xuICBwdWJsaWMgZ2V0IG9uT2ZmbGluZSgpOiBFdmVudEVtaXR0ZXI8dm9pZD4ge1xuICAgIHJldHVybiB0aGlzLl9vbk9mZmxpbmU7XG4gIH1cblxuICAvKiogQW4gRXZlbnRFbWl0dGVyIHRvIGxpc3RlbiB0byBlcnJvciBldmVudHMgKi9cbiAgcHVibGljIGdldCBvbkVycm9yKCk6IEV2ZW50RW1pdHRlcjxJT25FcnJvckV2ZW50PiB7XG4gICAgcmV0dXJuIHRoaXMuX29uRXJyb3I7XG4gIH1cblxuICAvKiogQW4gRXZlbnRFbWl0dGVyIHRvIGxpc3RlbiB0byBjbG9zZSBtZXNzYWdlcyAqL1xuICBwdWJsaWMgZ2V0IG9uRW5kKCk6IEV2ZW50RW1pdHRlcjx2b2lkPiB7XG4gICAgcmV0dXJuIHRoaXMuX29uRW5kO1xuICB9XG5cbiAgLyoqIEFuIEV2ZW50RW1pdHRlciB0byBsaXN0ZW4gdG8gbWVzc2FnZSBldmVudHMgKi9cbiAgcHVibGljIGdldCBvbk1lc3NhZ2UoKTogRXZlbnRFbWl0dGVyPFBhY2tldD4ge1xuICAgIHJldHVybiB0aGlzLl9vbk1lc3NhZ2U7XG4gIH1cblxuICAvKiogQW4gRXZlbnRFbWl0dGVyIHRvIGxpc3RlbiB0byBwYWNrZXRzZW5kIG1lc3NhZ2VzICovXG4gIHB1YmxpYyBnZXQgb25QYWNrZXRzZW5kKCk6IEV2ZW50RW1pdHRlcjxJT25QYWNrZXRzZW5kRXZlbnQ+IHtcbiAgICByZXR1cm4gdGhpcy5fb25QYWNrZXRzZW5kO1xuICB9XG5cbiAgLyoqIEFuIEV2ZW50RW1pdHRlciB0byBsaXN0ZW4gdG8gcGFja2V0cmVjZWl2ZSBtZXNzYWdlcyAqL1xuICBwdWJsaWMgZ2V0IG9uUGFja2V0cmVjZWl2ZSgpOiBFdmVudEVtaXR0ZXI8SU9uUGFja2V0cmVjZWl2ZUV2ZW50PiB7XG4gICAgcmV0dXJuIHRoaXMuX29uUGFja2V0cmVjZWl2ZTtcbiAgfVxuXG4gIC8qKiBBbiBFdmVudEVtaXR0ZXIgdG8gbGlzdGVuIHRvIHN1YmFjayBldmVudHMgKi9cbiAgcHVibGljIGdldCBvblN1YmFjaygpOiBFdmVudEVtaXR0ZXI8SU9uU3ViYWNrRXZlbnQ+IHtcbiAgICByZXR1cm4gdGhpcy5fb25TdWJhY2s7XG4gIH1cbiAgLyoqIGEgbWFwIG9mIGFsbCBtcXR0IG9ic2VydmFibGVzIGJ5IGZpbHRlciAqL1xuICBwdWJsaWMgb2JzZXJ2YWJsZXM6IHsgW2ZpbHRlclN0cmluZzogc3RyaW5nXTogT2JzZXJ2YWJsZTxJTXF0dE1lc3NhZ2U+IH0gPSB7fTtcbiAgLyoqIHRoZSBjb25uZWN0aW9uIHN0YXRlICovXG4gIHB1YmxpYyBzdGF0ZTogU3ViamVjdDxNcXR0Q29ubmVjdGlvblN0YXRlPiA9IG5ldyBCZWhhdmlvclN1YmplY3Q8TXF0dENvbm5lY3Rpb25TdGF0ZT4oTXF0dENvbm5lY3Rpb25TdGF0ZS5DTE9TRUQpO1xuICAvKiogYW4gb2JzZXJ2YWJsZSBvZiB0aGUgbGFzdCBtcXR0IG1lc3NhZ2UgKi9cbiAgcHVibGljIG1lc3NhZ2VzOiBTdWJqZWN0PElNcXR0TWVzc2FnZT4gPSBuZXcgU3ViamVjdDxJTXF0dE1lc3NhZ2U+KCk7XG5cbiAgcHJpdmF0ZSBfY2xpZW50SWQgPSB0aGlzLl9nZW5lcmF0ZUNsaWVudElkKCk7XG4gIHByaXZhdGUgX2Nvbm5lY3RUaW1lb3V0ID0gMTAwMDA7XG4gIHByaXZhdGUgX3JlY29ubmVjdFBlcmlvZCA9IDEwMDAwO1xuICBwcml2YXRlIF91cmwhOiBzdHJpbmc7XG5cbiAgcHJpdmF0ZSBfb25Db25uZWN0OiBFdmVudEVtaXR0ZXI8SU9uQ29ubmVjdEV2ZW50PiA9IG5ldyBFdmVudEVtaXR0ZXI8SU9uQ29ubmVjdEV2ZW50PigpO1xuICBwcml2YXRlIF9vblJlY29ubmVjdDogRXZlbnRFbWl0dGVyPHZvaWQ+ID0gbmV3IEV2ZW50RW1pdHRlcjx2b2lkPigpO1xuICBwcml2YXRlIF9vbkNsb3NlOiBFdmVudEVtaXR0ZXI8dm9pZD4gPSBuZXcgRXZlbnRFbWl0dGVyPHZvaWQ+KCk7XG4gIHByaXZhdGUgX29uT2ZmbGluZTogRXZlbnRFbWl0dGVyPHZvaWQ+ID0gbmV3IEV2ZW50RW1pdHRlcjx2b2lkPigpO1xuICBwcml2YXRlIF9vbkVycm9yOiBFdmVudEVtaXR0ZXI8SU9uRXJyb3JFdmVudD4gPSBuZXcgRXZlbnRFbWl0dGVyPElPbkVycm9yRXZlbnQ+KCk7XG4gIHByaXZhdGUgX29uRW5kOiBFdmVudEVtaXR0ZXI8dm9pZD4gPSBuZXcgRXZlbnRFbWl0dGVyPHZvaWQ+KCk7XG4gIHByaXZhdGUgX29uTWVzc2FnZTogRXZlbnRFbWl0dGVyPFBhY2tldD4gPSBuZXcgRXZlbnRFbWl0dGVyPFBhY2tldD4oKTtcbiAgcHJpdmF0ZSBfb25TdWJhY2s6IEV2ZW50RW1pdHRlcjxJT25TdWJhY2tFdmVudD4gPSBuZXcgRXZlbnRFbWl0dGVyPElPblN1YmFja0V2ZW50PigpO1xuICBwcml2YXRlIF9vblBhY2tldHNlbmQ6IEV2ZW50RW1pdHRlcjxJT25QYWNrZXRzZW5kRXZlbnQ+ID0gbmV3IEV2ZW50RW1pdHRlcjxJT25QYWNrZXRzZW5kRXZlbnQ+KCk7XG4gIHByaXZhdGUgX29uUGFja2V0cmVjZWl2ZTogRXZlbnRFbWl0dGVyPElPblBhY2tldHJlY2VpdmVFdmVudD4gPSBuZXcgRXZlbnRFbWl0dGVyPElPblBhY2tldHJlY2VpdmVFdmVudD4oKTtcblxuICAvKipcbiAgICogVGhpcyBzdGF0aWMgbWV0aG9kIHNoYWxsIGJlIHVzZWQgdG8gZGV0ZXJtaW5lIHdoZXRoZXIgYSBNUVRUXG4gICAqIHRvcGljIG1hdGNoZXMgYSBnaXZlbiBmaWx0ZXIuIFRoZSBtYXRjaGluZyBydWxlcyBhcmUgc3BlY2lmaWVkIGluIHRoZSBNUVRUXG4gICAqIHN0YW5kYXJkIGRvY3VtZW50YXRpb24gYW5kIGluIHRoZSBsaWJyYXJ5IHRlc3Qgc3VpdGUuXG4gICAqXG4gICAqIEBwYXJhbSAge3N0cmluZ30gIGZpbHRlciBBIGZpbHRlciBtYXkgY29udGFpbiB3aWxkY2FyZHMgbGlrZSAnIycgYW5kICcrJy5cbiAgICogQHBhcmFtICB7c3RyaW5nfSAgdG9waWMgIEEgdG9waWMgbWF5IG5vdCBjb250YWluIHdpbGRjYXJkcy5cbiAgICogQHJldHVybiB7Ym9vbGVhbn0gICAgICAgIHRydWUgb24gbWF0Y2ggYW5kIGZhbHNlIG90aGVyd2lzZS5cbiAgICovXG4gIHB1YmxpYyBzdGF0aWMgZmlsdGVyTWF0Y2hlc1RvcGljKGZpbHRlclN0cmluZzogc3RyaW5nLCB0b3BpYzogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgaWYgKGZpbHRlclN0cmluZ1swXSA9PT0gJyMnICYmIHRvcGljWzBdID09PSAnJCcpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgLy8gUHJlcGFyYXRpb246IHNwbGl0IGFuZCByZXZlcnNlIG9uICcvJy4gVGhlIEphdmFTY3JpcHQgc3BsaXQgZnVuY3Rpb24gaXMgc2FuZS5cbiAgICBjb25zdCBmcyA9IChmaWx0ZXJTdHJpbmcgfHwgJycpLnNwbGl0KCcvJykucmV2ZXJzZSgpO1xuICAgIGNvbnN0IHRzID0gKHRvcGljIHx8ICcnKS5zcGxpdCgnLycpLnJldmVyc2UoKTtcbiAgICAvLyBUaGlzIGZ1bmN0aW9uIGlzIHRhaWwgcmVjdXJzaXZlIGFuZCBjb21wYXJlcyBib3RoIGFycmF5cyBvbmUgZWxlbWVudCBhdCBhIHRpbWUuXG4gICAgY29uc3QgbWF0Y2ggPSAoKTogYm9vbGVhbiA9PiB7XG4gICAgICAvLyBDdXR0aW5nIG9mIHRoZSBsYXN0IGVsZW1lbnQgb2YgYm90aCB0aGUgZmlsdGVyIGFuZCB0aGUgdG9waWMgdXNpbmcgcG9wKCkuXG4gICAgICBjb25zdCBmID0gZnMucG9wKCk7XG4gICAgICBjb25zdCB0ID0gdHMucG9wKCk7XG4gICAgICBzd2l0Y2ggKGYpIHtcbiAgICAgICAgLy8gSW4gY2FzZSB0aGUgZmlsdGVyIGxldmVsIGlzICcjJywgdGhpcyBpcyBhIG1hdGNoIG5vIG1hdHRlciB3aGV0aGVyXG4gICAgICAgIC8vIHRoZSB0b3BpYyBpcyB1bmRlZmluZWQgb24gdGhpcyBsZXZlbCBvciBub3QgKCcjJyBtYXRjaGVzIHBhcmVudCBlbGVtZW50IGFzIHdlbGwhKS5cbiAgICAgICAgY2FzZSAnIyc6XG4gICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIC8vIEluIGNhc2UgdGhlIGZpbHRlciBsZXZlbCBpcyAnKycsIHdlIHNoYWxsIGRpdmUgaW50byB0aGUgcmVjdXJzaW9uIG9ubHkgaWYgdCBpcyBub3QgdW5kZWZpbmVkLlxuICAgICAgICBjYXNlICcrJzpcbiAgICAgICAgICByZXR1cm4gdCA/IG1hdGNoKCkgOiBmYWxzZTtcbiAgICAgICAgLy8gSW4gYWxsIG90aGVyIGNhc2VzIHRoZSBmaWx0ZXIgbGV2ZWwgbXVzdCBtYXRjaCB0aGUgdG9waWMgbGV2ZWwsXG4gICAgICAgIC8vIGJvdGggbXVzdCBiZSBkZWZpbmVkIGFuZCB0aGUgZmlsdGVyIHRhaWwgbXVzdCBtYXRjaCB0aGUgdG9waWNcbiAgICAgICAgLy8gdGFpbCAod2hpY2ggaXMgZGV0ZXJtaW5lZCBieSB0aGUgcmVjdXJzaXZlIGNhbGwgb2YgbWF0Y2goKSkuXG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgcmV0dXJuIGYgPT09IHQgJiYgKGYgPT09IHVuZGVmaW5lZCA/IHRydWUgOiBtYXRjaCgpKTtcbiAgICAgIH1cbiAgICB9O1xuICAgIHJldHVybiBtYXRjaCgpO1xuICB9XG5cbiAgLyoqXG4gICAqIGNvbm5lY3QgbWFudWFsbHkgY29ubmVjdHMgdG8gdGhlIG1xdHQgYnJva2VyLlxuICAgKi9cbiAgcHVibGljIGNvbm5lY3Qob3B0cz86IElNcXR0U2VydmljZU9wdGlvbnMsIGNsaWVudD86IE1xdHRDbGllbnQpIHtcbiAgICBjb25zdCBvcHRpb25zID0gbWVyZ2VEZWVwKHRoaXMub3B0aW9ucyB8fCB7fSwgb3B0cyk7XG4gICAgY29uc3QgcHJvdG9jb2wgPSBvcHRpb25zLnByb3RvY29sIHx8ICd3cyc7XG4gICAgY29uc3QgaG9zdG5hbWUgPSBvcHRpb25zLmhvc3RuYW1lIHx8ICdsb2NhbGhvc3QnO1xuICAgIGlmIChvcHRpb25zLnVybCkge1xuICAgICAgdGhpcy5fdXJsID0gb3B0aW9ucy51cmw7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuX3VybCA9IGAke3Byb3RvY29sfTovLyR7aG9zdG5hbWV9YDtcbiAgICAgIHRoaXMuX3VybCArPSBvcHRpb25zLnBvcnQgPyBgOiR7b3B0aW9ucy5wb3J0fWAgOiAnJztcbiAgICAgIHRoaXMuX3VybCArPSBvcHRpb25zLnBhdGggPyBgJHtvcHRpb25zLnBhdGh9YCA6ICcnO1xuICAgIH1cbiAgICB0aGlzLnN0YXRlLm5leHQoTXF0dENvbm5lY3Rpb25TdGF0ZS5DT05ORUNUSU5HKTtcbiAgICBjb25zdCBtZXJnZWRPcHRpb25zID0gbWVyZ2VEZWVwKHtcbiAgICAgIGNsaWVudElkOiB0aGlzLl9jbGllbnRJZCxcbiAgICAgIHJlY29ubmVjdFBlcmlvZDogdGhpcy5fcmVjb25uZWN0UGVyaW9kLFxuICAgICAgY29ubmVjdFRpbWVvdXQ6IHRoaXMuX2Nvbm5lY3RUaW1lb3V0XG4gICAgfSwgb3B0aW9ucyk7XG5cbiAgICBpZiAodGhpcy5jbGllbnQpIHtcbiAgICAgIHRoaXMuY2xpZW50LmVuZCh0cnVlKTtcbiAgICB9XG5cbiAgICBpZiAoIWNsaWVudCkge1xuICAgICAgdGhpcy5jbGllbnQgPSBjb25uZWN0KHRoaXMuX3VybCwgbWVyZ2VkT3B0aW9ucyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuY2xpZW50ID0gY2xpZW50O1xuICAgIH1cbiAgICB0aGlzLl9jbGllbnRJZCA9IG1lcmdlZE9wdGlvbnMuY2xpZW50SWQ7XG5cbiAgICB0aGlzLmNsaWVudC5vbignY29ubmVjdCcsIHRoaXMuX2hhbmRsZU9uQ29ubmVjdCk7XG4gICAgdGhpcy5jbGllbnQub24oJ3JlY29ubmVjdCcsIHRoaXMuX2hhbmRsZU9uUmVjb25uZWN0KTtcbiAgICB0aGlzLmNsaWVudC5vbignY2xvc2UnLCB0aGlzLl9oYW5kbGVPbkNsb3NlKTtcbiAgICB0aGlzLmNsaWVudC5vbignb2ZmbGluZScsIHRoaXMuX2hhbmRsZU9uT2ZmbGluZSk7XG4gICAgdGhpcy5jbGllbnQub24oJ2Vycm9yJywgdGhpcy5faGFuZGxlT25FcnJvcik7XG4gICAgKHRoaXMuY2xpZW50IGFzIGFueSkuc3RyZWFtLm9uKCdlcnJvcicsIHRoaXMuX2hhbmRsZU9uRXJyb3IpO1xuICAgIHRoaXMuY2xpZW50Lm9uKCdlbmQnLCB0aGlzLl9oYW5kbGVPbkVuZCk7XG4gICAgdGhpcy5jbGllbnQub24oJ21lc3NhZ2UnLCB0aGlzLl9oYW5kbGVPbk1lc3NhZ2UpO1xuICAgIHRoaXMuY2xpZW50Lm9uKCdwYWNrZXRzZW5kJywgdGhpcy5faGFuZGxlT25QYWNrZXRzZW5kKTtcbiAgICB0aGlzLmNsaWVudC5vbigncGFja2V0cmVjZWl2ZScsIHRoaXMuX2hhbmRsZU9uUGFja2V0cmVjZWl2ZSk7XG4gIH1cblxuICAvKipcbiAgICogZGlzY29ubmVjdCBkaXNjb25uZWN0cyBmcm9tIHRoZSBtcXR0IGNsaWVudC5cbiAgICogVGhpcyBtZXRob2QgYHNob3VsZGAgYmUgZXhlY3V0ZWQgd2hlbiBsZWF2aW5nIHRoZSBhcHBsaWNhdGlvbi5cbiAgICovXG4gIHB1YmxpYyBkaXNjb25uZWN0KGZvcmNlID0gdHJ1ZSkge1xuICAgIGlmICghdGhpcy5jbGllbnQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignbXF0dCBjbGllbnQgbm90IGNvbm5lY3RlZCcpO1xuICAgIH1cbiAgICB0aGlzLmNsaWVudC5lbmQoZm9yY2UpO1xuICB9XG5cbiAgLyoqXG4gICAqIFdpdGggdGhpcyBtZXRob2QsIHlvdSBjYW4gb2JzZXJ2ZSBtZXNzYWdlcyBmb3IgYSBtcXR0IHRvcGljLlxuICAgKiBUaGUgb2JzZXJ2YWJsZSB3aWxsIG9ubHkgZW1pdCBtZXNzYWdlcyBtYXRjaGluZyB0aGUgZmlsdGVyLlxuICAgKiBUaGUgZmlyc3Qgb25lIHN1YnNjcmliaW5nIHRvIHRoZSByZXN1bHRpbmcgb2JzZXJ2YWJsZSBleGVjdXRlcyBhIG1xdHQgc3Vic2NyaWJlLlxuICAgKiBUaGUgbGFzdCBvbmUgdW5zdWJzY3JpYmluZyB0aGlzIGZpbHRlciBleGVjdXRlcyBhIG1xdHQgdW5zdWJzY3JpYmUuXG4gICAqIEV2ZXJ5IG5ldyBzdWJzY3JpYmVyIGdldHMgdGhlIGxhdGVzdCBtZXNzYWdlLlxuICAgKi9cbiAgcHVibGljIG9ic2VydmVSZXRhaW5lZChmaWx0ZXJTdHJpbmc6IHN0cmluZywgb3B0czogSUNsaWVudFN1YnNjcmliZU9wdGlvbnMgPSB7IHFvczogMSB9KTogT2JzZXJ2YWJsZTxJTXF0dE1lc3NhZ2U+IHtcbiAgICByZXR1cm4gdGhpcy5fZ2VuZXJhbE9ic2VydmUoZmlsdGVyU3RyaW5nLCAoKSA9PiBwdWJsaXNoUmVwbGF5KDEpLCBvcHRzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBXaXRoIHRoaXMgbWV0aG9kLCB5b3UgY2FuIG9ic2VydmUgbWVzc2FnZXMgZm9yIGEgbXF0dCB0b3BpYy5cbiAgICogVGhlIG9ic2VydmFibGUgd2lsbCBvbmx5IGVtaXQgbWVzc2FnZXMgbWF0Y2hpbmcgdGhlIGZpbHRlci5cbiAgICogVGhlIGZpcnN0IG9uZSBzdWJzY3JpYmluZyB0byB0aGUgcmVzdWx0aW5nIG9ic2VydmFibGUgZXhlY3V0ZXMgYSBtcXR0IHN1YnNjcmliZS5cbiAgICogVGhlIGxhc3Qgb25lIHVuc3Vic2NyaWJpbmcgdGhpcyBmaWx0ZXIgZXhlY3V0ZXMgYSBtcXR0IHVuc3Vic2NyaWJlLlxuICAgKi9cbiAgcHVibGljIG9ic2VydmUoZmlsdGVyU3RyaW5nOiBzdHJpbmcsIG9wdHM6IElDbGllbnRTdWJzY3JpYmVPcHRpb25zID0geyBxb3M6IDEgfSk6IE9ic2VydmFibGU8SU1xdHRNZXNzYWdlPiB7XG4gICAgcmV0dXJuIHRoaXMuX2dlbmVyYWxPYnNlcnZlKGZpbHRlclN0cmluZywgKCkgPT4gcHVibGlzaCgpLCBvcHRzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBXaXRoIHRoaXMgbWV0aG9kLCB5b3UgY2FuIG9ic2VydmUgbWVzc2FnZXMgZm9yIGEgbXF0dCB0b3BpYy5cbiAgICogVGhlIG9ic2VydmFibGUgd2lsbCBvbmx5IGVtaXQgbWVzc2FnZXMgbWF0Y2hpbmcgdGhlIGZpbHRlci5cbiAgICogVGhlIGZpcnN0IG9uZSBzdWJzY3JpYmluZyB0byB0aGUgcmVzdWx0aW5nIG9ic2VydmFibGUgZXhlY3V0ZXMgYSBtcXR0IHN1YnNjcmliZS5cbiAgICogVGhlIGxhc3Qgb25lIHVuc3Vic2NyaWJpbmcgdGhpcyBmaWx0ZXIgZXhlY3V0ZXMgYSBtcXR0IHVuc3Vic2NyaWJlLlxuICAgKiBEZXBlbmRpbmcgb24gdGhlIHB1Ymxpc2ggZnVuY3Rpb24sIHRoZSBtZXNzYWdlcyB3aWxsIGVpdGhlciBiZSByZXBsYXllZCBhZnRlciBuZXdcbiAgICogc3Vic2NyaWJlcnMgc3Vic2NyaWJlIG9yIHRoZSBtZXNzYWdlcyBhcmUganVzdCBwYXNzZWQgdGhyb3VnaFxuICAgKi9cbiAgcHJpdmF0ZSBfZ2VuZXJhbE9ic2VydmUoZmlsdGVyU3RyaW5nOiBzdHJpbmcsIHB1Ymxpc2hGbjogRnVuY3Rpb24sIG9wdHM6IElDbGllbnRTdWJzY3JpYmVPcHRpb25zKTogT2JzZXJ2YWJsZTxJTXF0dE1lc3NhZ2U+IHtcbiAgICBpZiAoIXRoaXMuY2xpZW50KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ21xdHQgY2xpZW50IG5vdCBjb25uZWN0ZWQnKTtcbiAgICB9XG4gICAgaWYgKCF0aGlzLm9ic2VydmFibGVzW2ZpbHRlclN0cmluZ10pIHtcbiAgICAgIGNvbnN0IHJlamVjdGVkOiBTdWJqZWN0PElNcXR0TWVzc2FnZT4gPSBuZXcgU3ViamVjdCgpO1xuICAgICAgdGhpcy5vYnNlcnZhYmxlc1tmaWx0ZXJTdHJpbmddID0gdXNpbmcoXG4gICAgICAgIC8vIHJlc291cmNlRmFjdG9yeTogRG8gdGhlIGFjdHVhbCByZWYtY291bnRpbmcgTVFUVCBzdWJzY3JpcHRpb24uXG4gICAgICAgIC8vIHJlZmNvdW50IGlzIGRlY3JlYXNlZCBvbiB1bnN1YnNjcmliZS5cbiAgICAgICAgKCkgPT4ge1xuICAgICAgICAgIGNvbnN0IHN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uID0gbmV3IFN1YnNjcmlwdGlvbigpO1xuICAgICAgICAgIHRoaXMuY2xpZW50LnN1YnNjcmliZShmaWx0ZXJTdHJpbmcsIG9wdHMsIChlcnI6IGFueSwgZ3JhbnRlZDogSVN1YnNjcmlwdGlvbkdyYW50W10pID0+IHtcbiAgICAgICAgICAgIGlmIChncmFudGVkKSB7IC8vIGdyYW50ZWQgY2FuIGJlIHVuZGVmaW5lZCB3aGVuIGFuIGVycm9yIG9jY3VycyB3aGVuIHRoZSBjbGllbnQgaXMgZGlzY29ubmVjdGluZ1xuICAgICAgICAgICAgICBncmFudGVkLmZvckVhY2goKGdyYW50ZWRfOiBJU3Vic2NyaXB0aW9uR3JhbnQpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoZ3JhbnRlZF8ucW9zID09PSAxMjgpIHtcbiAgICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLm9ic2VydmFibGVzW2dyYW50ZWRfLnRvcGljXTtcbiAgICAgICAgICAgICAgICAgIHRoaXMuY2xpZW50LnVuc3Vic2NyaWJlKGdyYW50ZWRfLnRvcGljKTtcbiAgICAgICAgICAgICAgICAgIHJlamVjdGVkLmVycm9yKGBzdWJzY3JpcHRpb24gZm9yICcke2dyYW50ZWRfLnRvcGljfScgcmVqZWN0ZWQhYCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHRoaXMuX29uU3ViYWNrLmVtaXQoeyBmaWx0ZXI6IGZpbHRlclN0cmluZywgZ3JhbnRlZDogZ3JhbnRlZF8ucW9zICE9PSAxMjggfSk7XG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICAgIHN1YnNjcmlwdGlvbi5hZGQoKCkgPT4ge1xuICAgICAgICAgICAgZGVsZXRlIHRoaXMub2JzZXJ2YWJsZXNbZmlsdGVyU3RyaW5nXTtcbiAgICAgICAgICAgIHRoaXMuY2xpZW50LnVuc3Vic2NyaWJlKGZpbHRlclN0cmluZyk7XG4gICAgICAgICAgfSk7XG4gICAgICAgICAgcmV0dXJuIHN1YnNjcmlwdGlvbjtcbiAgICAgICAgfSxcbiAgICAgICAgLy8gb2JzZXJ2YWJsZUZhY3Rvcnk6IENyZWF0ZSB0aGUgb2JzZXJ2YWJsZSB0aGF0IGlzIGNvbnN1bWVkIGZyb20uXG4gICAgICAgIC8vIFRoaXMgcGFydCBpcyBub3QgZXhlY3V0ZWQgdW50aWwgdGhlIE9ic2VydmFibGUgcmV0dXJuZWQgYnlcbiAgICAgICAgLy8gYG9ic2VydmVgIGdldHMgYWN0dWFsbHkgc3Vic2NyaWJlZC5cbiAgICAgICAgKHN1YnNjcmlwdGlvbjogVW5zdWJzY3JpYmFibGUgfCB2b2lkKSA9PiBtZXJnZShyZWplY3RlZCwgdGhpcy5tZXNzYWdlcykpXG4gICAgICAgIC5waXBlKFxuICAgICAgICAgIGZpbHRlcigobXNnOiBJTXF0dE1lc3NhZ2UpID0+IE1xdHRTZXJ2aWNlLmZpbHRlck1hdGNoZXNUb3BpYyhmaWx0ZXJTdHJpbmcsIG1zZy50b3BpYykpLFxuICAgICAgICAgIHB1Ymxpc2hGbigpLFxuICAgICAgICAgIHJlZkNvdW50KClcbiAgICAgICAgKSBhcyBPYnNlcnZhYmxlPElNcXR0TWVzc2FnZT47XG4gICAgfVxuICAgIHJldHVybiB0aGlzLm9ic2VydmFibGVzW2ZpbHRlclN0cmluZ107XG4gIH1cblxuICAvKipcbiAgICogVGhpcyBtZXRob2QgcmV0dXJucyBhbiBvYnNlcnZhYmxlIGZvciBhIHRvcGljIHdpdGggb3B0aW9uYWwgb3B0aW9ucy5cbiAgICogQWZ0ZXIgc3Vic2NyaWJpbmcsIHRoZSBhY3R1YWwgbXF0dCBwdWJsaWNhdGlvbiB3aWxsIGJlIGV4ZWN1dGVkIGFuZFxuICAgKiB0aGUgb2JzZXJ2YWJsZSB3aWxsIGVtaXQgYW4gZW1wdHkgdmFsdWUgYW5kIGNvbXBsZXRlcywgaWYgcHVibGlzaGluZyB3YXMgc3VjY2Vzc2Z1bFxuICAgKiBvciB0aHJvd3MgYW4gZXJyb3IsIGlmIHRoZSBwdWJsaWNhdGlvbiBmYWlscy5cbiAgICovXG4gIHB1YmxpYyBwdWJsaXNoKHRvcGljOiBzdHJpbmcsIG1lc3NhZ2U6IHN0cmluZyB8IEJ1ZmZlciwgb3B0aW9uczogSUNsaWVudFB1Ymxpc2hPcHRpb25zID0ge30pOiBPYnNlcnZhYmxlPHZvaWQ+IHtcbiAgICBpZiAoIXRoaXMuY2xpZW50KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ21xdHQgY2xpZW50IG5vdCBjb25uZWN0ZWQnKTtcbiAgICB9XG4gICAgcmV0dXJuIE9ic2VydmFibGUuY3JlYXRlKChvYnM6IE9ic2VydmVyPHZvaWQ+KSA9PiB7XG4gICAgICB0aGlzLmNsaWVudC5wdWJsaXNoKHRvcGljLCBtZXNzYWdlLCBvcHRpb25zLCAoZXJyb3I6IEVycm9yIHwgdW5kZWZpbmVkKSA9PiB7XG4gICAgICAgIGlmIChlcnJvcikge1xuICAgICAgICAgIG9icy5lcnJvcihlcnJvcik7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgb2JzLm5leHQoKTtcbiAgICAgICAgICBvYnMuY29tcGxldGUoKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogVGhpcyBtZXRob2QgcHVibGlzaGVzIGEgbWVzc2FnZSBmb3IgYSB0b3BpYyB3aXRoIG9wdGlvbmFsIG9wdGlvbnMuXG4gICAqIElmIGFuIGVycm9yIG9jY3VycywgaXQgd2lsbCB0aHJvdy5cbiAgICovXG4gIHB1YmxpYyB1bnNhZmVQdWJsaXNoKHRvcGljOiBzdHJpbmcsIG1lc3NhZ2U6IHN0cmluZyB8IEJ1ZmZlciwgb3B0aW9uczogSVB1Ymxpc2hPcHRpb25zID0ge30pOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMuY2xpZW50KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ21xdHQgY2xpZW50IG5vdCBjb25uZWN0ZWQnKTtcbiAgICB9XG4gICAgdGhpcy5jbGllbnQucHVibGlzaCh0b3BpYywgbWVzc2FnZSwgb3B0aW9ucywgKGVycm9yOiBFcnJvciB8IHVuZGVmaW5lZCkgPT4ge1xuICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgIHRocm93IChlcnJvcik7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIF9oYW5kbGVPbkNvbm5lY3QgPSAoZTogSU9uQ29ubmVjdEV2ZW50KSA9PiB7XG4gICAgaWYgKHRoaXMub3B0aW9ucy5jb25uZWN0T25DcmVhdGUgPT09IHRydWUpIHtcbiAgICAgIE9iamVjdC5rZXlzKHRoaXMub2JzZXJ2YWJsZXMpLmZvckVhY2goKGZpbHRlclN0cmluZzogc3RyaW5nKSA9PiB7XG4gICAgICAgIHRoaXMuY2xpZW50LnN1YnNjcmliZShmaWx0ZXJTdHJpbmcpO1xuICAgICAgfSk7XG4gICAgfVxuICAgIHRoaXMuc3RhdGUubmV4dChNcXR0Q29ubmVjdGlvblN0YXRlLkNPTk5FQ1RFRCk7XG4gICAgdGhpcy5fb25Db25uZWN0LmVtaXQoZSk7XG4gIH1cblxuICBwcml2YXRlIF9oYW5kbGVPblJlY29ubmVjdCA9ICgpID0+IHtcbiAgICBpZiAodGhpcy5vcHRpb25zLmNvbm5lY3RPbkNyZWF0ZSA9PT0gdHJ1ZSkge1xuICAgICAgT2JqZWN0LmtleXModGhpcy5vYnNlcnZhYmxlcykuZm9yRWFjaCgoZmlsdGVyU3RyaW5nOiBzdHJpbmcpID0+IHtcbiAgICAgICAgdGhpcy5jbGllbnQuc3Vic2NyaWJlKGZpbHRlclN0cmluZyk7XG4gICAgICB9KTtcbiAgICB9XG4gICAgdGhpcy5zdGF0ZS5uZXh0KE1xdHRDb25uZWN0aW9uU3RhdGUuQ09OTkVDVElORyk7XG4gICAgdGhpcy5fb25SZWNvbm5lY3QuZW1pdCgpO1xuICB9XG5cbiAgcHJpdmF0ZSBfaGFuZGxlT25DbG9zZSA9ICgpID0+IHtcbiAgICB0aGlzLnN0YXRlLm5leHQoTXF0dENvbm5lY3Rpb25TdGF0ZS5DTE9TRUQpO1xuICAgIHRoaXMuX29uQ2xvc2UuZW1pdCgpO1xuICB9XG5cbiAgcHJpdmF0ZSBfaGFuZGxlT25PZmZsaW5lID0gKCkgPT4ge1xuICAgIHRoaXMuX29uT2ZmbGluZS5lbWl0KCk7XG4gIH1cblxuICBwcml2YXRlIF9oYW5kbGVPbkVycm9yID0gKGU6IElPbkVycm9yRXZlbnQpID0+IHtcbiAgICB0aGlzLl9vbkVycm9yLmVtaXQoZSk7XG4gICAgY29uc29sZS5lcnJvcihlKTtcbiAgfVxuXG4gIHByaXZhdGUgX2hhbmRsZU9uRW5kID0gKCkgPT4ge1xuICAgIHRoaXMuX29uRW5kLmVtaXQoKTtcbiAgfVxuXG4gIHByaXZhdGUgX2hhbmRsZU9uTWVzc2FnZSA9ICh0b3BpYzogc3RyaW5nLCBwYXlsb2FkOiBCdWZmZXIsIHBhY2tldDogUGFja2V0KSA9PiB7XG4gICAgdGhpcy5fb25NZXNzYWdlLmVtaXQocGFja2V0KTtcbiAgICBpZiAocGFja2V0LmNtZCA9PT0gJ3B1Ymxpc2gnKSB7XG4gICAgICB0aGlzLm1lc3NhZ2VzLm5leHQocGFja2V0IGFzIGFueSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBfaGFuZGxlT25QYWNrZXRzZW5kID0gKGU6IElPblBhY2tldHNlbmRFdmVudCkgPT4ge1xuICAgIHRoaXMuX29uUGFja2V0c2VuZC5lbWl0KGUpO1xuICB9XG5cbiAgcHJpdmF0ZSBfaGFuZGxlT25QYWNrZXRyZWNlaXZlID0gKGU6IElPblBhY2tldHJlY2VpdmVFdmVudCkgPT4ge1xuICAgIHRoaXMuX29uUGFja2V0cmVjZWl2ZS5lbWl0KGUpO1xuICB9XG5cbiAgcHJpdmF0ZSBfZ2VuZXJhdGVDbGllbnRJZCgpIHtcbiAgICByZXR1cm4gJ2NsaWVudC0nICsgTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyKDIsIDE5KTtcbiAgfVxufVxuIl19